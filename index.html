<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script defer type="module" src="./client/index.js"></script> -->
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Lets Talk</title>
    <style>
        .left,
        .right {
            border-radius: .8rem;
        }

        .left {
            border-bottom-left-radius: unset;
            border-bottom-right-radius: .6rem;
        }

        .right {
            border-bottom-right-radius: unset;
            border-bottom-left-radius: .6rem;
        }

        .messgaeContainer {
            height: 80%;
            overflow-y: auto;
        }
    </style>
</head>

<body class="h-screen w-screen bg-gradient-to-t from-slate-900 to-slate-950 text-white">
    <div id="login" class=" login flex flex-col items-center h-screen w-screen ">
        <main class=" top-0 text-center m-10 ">
            <h1 class="font-serif mb-3 font-bold text-4xl ">QuickChat</h1>
            <p class="max-w-[25rem] font-mono text-lg">Create your very secure key and start chatting, without any
                number or
                email
                verification!
            </p>
        </main>
        <div class="flex max-w-[25rem] rounded p-14 bg-slate-800 shadow-lg shadow-slate-950 flex-col">
            <h1 class="font-mono text-lg font-semibold">Your Secret Key</h1>
            <div class="flex">
                <input id="keyInputElm"
                    class=" bg-slate-100 active:bg-white focus:bg-white hover:bg-white outline-none h-12 w-full text-slate-800 text-center"
                    placeholder="very_secret_key" type="text">
                <button id="loginEnterButton" class="outline-none hover:bg-slate-700 px-5 bg-slate-600">Enter</button>
            </div>
            <span class="mt-2"><span class="font-bold">Tip:</span> Keep Your Key Long And Uniqe</span>
        </div>

        <div
            class="[&>p]:relative [&>p:before]:left-[-2.5rem] [&>p:before]:top-[-.7rem] [&>p:before]:content-['\2192'] [&>p:before]:text-lime-400 [&>p:before]:absolute [&>p:before]:text-4xl relative inline-block top-9 mx-12">
            <h2 class="text-xl font-semibold font-serif">How It Works?</h2>
            <p class=""> Choose you room key and press Enter: <span>Ex:
                    "secret_key"</span>
            </p>
            <p> Now share your secret key with someone you want to chat with: <span>Ex: "secret_key"</span></p>
            <p> Now when he/she enter your secret key, they automaticaly join your room</p>

        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        function $(selector = 'body') {
            const e = document.querySelectorAll(selector)
            if (e.length == 1) return e[0]
            if (e.length > 1) return e
        }

        function giveElement(tagName = 'div', classList = '', appendElm = '') {
            const elm = document.createElement(tagName)
            classList = classList.split(" ")
            if (classList != '') elm.classList.add(...classList)
            if (appendElm != '') elm.innerHTML = appendElm
            return elm
        }

        const socket = io({
            autoConnect: false
        });

        let secret_key = undefined

        // have to change class string to array

        const chatContainer = giveElement('div', 'px-3 pt-2 flex flex-col [&>p]:px-4 [&>p]:py-2 [&>p]:bg-slate-700')

        const messgaeContainer = giveElement('div', 'messgaeContainer gap-3 px-3 mx-3 pt-2 flex flex-col [&>p]:px-4 [&>p]:py-2 [&>p]:bg-slate-700')

        // this box is container for input send message
        const sendMessageBox = giveElement('div', 'flex w-full fixed bottom-0')

        const inputElm = giveElement('textarea', 'text-center py-3 px-1 bg-slate-100 active:bg-white focus:bg-white hover:bg-white outline-none h-14 w-full text-slate-800 text-center')

        inputElm.placeholder = "Type Your Message"

        const sendMessageButton = giveElement('button', 'outline-none hover:bg-slate-700 px-5 bg-slate-600')

        sendMessageButton.innerText = "Send"

        sendMessageBox.append(inputElm, sendMessageButton)

        chatContainer.append(messgaeContainer)





        document.getElementById('loginEnterButton').addEventListener('click', () => {
            socket.connect();
        })

        socket.on('connect', () => {
            console.log(`Connected to server with ID: ${socket.id}`);

            const room = document.getElementById('keyInputElm').value;
            if (!room) return
            secret_key = room
            socket.emit('joinRoom', room);
            // removing login
            document.getElementById('login').remove()

            document.body.append(chatContainer, sendMessageBox)

            document.body.append(sendMessageBox)

            // console.log(sendMessageButton)
            function handleMessage() {

                const messageData = {
                    room: secret_key,
                    message: inputElm.value
                };
                socket.emit('chatMessage', messageData);

                const messageElm = giveElement('p', 'relative right mx-3 self-end')
                messageElm.innerText = messageData.message

                messgaeContainer.append(messageElm)
                inputElm.value = ""
                inputElm.focus()
            }
            try {
                sendMessageButton.addEventListener('click', handleMessage)
            } catch (error) {
                console.log(error)
            }
            alert("We Aren't Saving Your Chats Right Now!")
            inputElm.focus()
        });

        socket.on('chatMessage', (message) => {
            console.log(`Received message: ${message}`);
            const messageElm = giveElement('p', 'relative left mx-3 self-start')
            messageElm.innerText = message

            messgaeContainer.append(messageElm)
        });





    </script>
</body>

</html>